# Apache VirtualHost configuration for both HTTP and SSL

Mutex default

ProxyErrorOverride on
ProxyPass / http://dvwa:80/ disablereuse=on
ProxyPassReverse / http://dvwa:80/
ProxyPreserveHost on
ProxyRequests off
ProxyTimeout 60

RemoteIPHeader X-Forwarded-For
RemoteIPInternalProxy 10.1.0.0/16

RequestHeader set X-Forwarded-Proto "https"
RequestHeader set X-Real-IP %{REMOTE_ADDR}s
RequestHeader set X-Unique-ID %{UNIQUE_ID}e

RewriteCond %{HTTP:Upgrade} websocket [NC]
RewriteCond %{HTTP:Connection} upgrade [NC]
RewriteEngine on
RewriteRule .* "ws://localhost:8081%{REQUEST_URI}" [P]

ServerName localhost
ServerAdmin root@localhost

SSLProxyEngine off
SSLProxyVerify none
SSLProxyCheckPeerName off
SSLProxyCACertificateFile /etc/ssl/certs/ca-certificates.crt

UseCanonicalName on

<VirtualHost *:80>
  Protocols h2 h2c http/1.1
  H2Direct on
  RewriteEngine On
  RewriteCond %{REQUEST_URI} !^/\.well\-known/acme\-challenge/
  RewriteCond %{ENV:APACHE_ALWAYS_TLS_REDIRECT} on
  RewriteRule ^(.*)$ https://%{SERVER_NAME}:8443$1 [L,R=301]
</VirtualHost>

<VirtualHost *:8443>
  Protocols h2 h2c http/1.1
  H2Direct on
  SSLEngine on
  SSLCertificateFile /usr/local/apache2/conf/server.crt
  SSLCertificateKeyFile /usr/local/apache2/conf/server.key
</VirtualHost>
