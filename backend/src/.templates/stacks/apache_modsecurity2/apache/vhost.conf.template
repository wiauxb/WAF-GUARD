# ============================================================================
# Virtual Host: ${VHOST_NAME}
# Backend: ${VHOST_BACKEND_URL}
# Apps: ${VHOST_APPS}
# Generated by WAF-Guard
# ============================================================================

# === HTTP VirtualHost ===
<VirtualHost *:${VHOST_HTTP_PORT}>
    ServerName ${VHOST_NAME}
    ServerAdmin ${VHOST_SERVER_ADMIN}

    # Logging
    ErrorLog ${VHOST_LOG_DIR}/${VHOST_NAME}_error.log
    CustomLog ${VHOST_LOG_DIR}/${VHOST_NAME}_access.log wafguard

    # HTTPS Redirect (if SSL enabled) - redirect before any processing
    <If "${VHOST_SSL_ENABLED} == 'true'">
        RewriteEngine On
        RewriteCond %{REQUEST_URI} !^${VHOST_HEALTH_CHECK_PATH}
        RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
    </If>

    # Health Check endpoint (always available, even during redirect)
    <Location "${VHOST_HEALTH_CHECK_PATH}">
        ProxyPass "!"
        Require all granted
    </Location>

    # Only serve content if SSL is not enabled
    <If "${VHOST_SSL_ENABLED} != 'true'">
        # ModSecurity rules for this VHost
        Include /etc/modsecurity.d/vhosts/${VHOST_NAME}-setup.conf

        # Document Root (for health checks or static files)
        DocumentRoot "${VHOST_DOCUMENT_ROOT}"

        <Directory "${VHOST_DOCUMENT_ROOT}">
            Options -Indexes -FollowSymLinks
            AllowOverride None
            Require all granted
        </Directory>

        # Reverse Proxy to backend
        ProxyPass / ${VHOST_BACKEND_URL}/
        ProxyPassReverse / ${VHOST_BACKEND_URL}/

        # WebSocket support
        RewriteEngine On
        RewriteCond %{HTTP:Upgrade} websocket [NC]
        RewriteCond %{HTTP:Connection} upgrade [NC]
        RewriteRule ^/?(.*) "ws://${VHOST_BACKEND_URL}/$1" [P,L]

        # Security Headers
        <IfModule headers_module>
            Header always set X-Content-Type-Options "nosniff"
            Header always set X-Frame-Options "${VHOST_X_FRAME_OPTIONS}"
            Header always set Referrer-Policy "${VHOST_REFERRER_POLICY}"
            Header always set Permissions-Policy "${VHOST_PERMISSIONS_POLICY}"
            Header always set Content-Security-Policy "${VHOST_CSP}"
        </IfModule>
    </If>
</VirtualHost>

# === HTTPS VirtualHost (if enabled) ===
<If "${VHOST_SSL_ENABLED} == 'true'">
<VirtualHost *:${VHOST_HTTPS_PORT}>
    ServerName ${VHOST_NAME}
    ServerAdmin ${VHOST_SERVER_ADMIN}

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile ${VHOST_SSL_CERT}
    SSLCertificateKeyFile ${VHOST_SSL_KEY}

    <IfFile "${VHOST_SSL_CHAIN}">
        SSLCertificateChainFile ${VHOST_SSL_CHAIN}
    </IfFile>

    # SSL Hardening
    SSLProtocol ${SSL_PROTOCOLS}
    SSLCipherSuite ${SSL_CIPHERS}
    SSLHonorCipherOrder ${SSL_HONOR_CIPHER_ORDER}
    SSLCompression off
    SSLSessionTickets off

    # OCSP Stapling
    <If "${SSL_OCSP_STAPLING} == 'On'">
        SSLUseStapling On
        SSLStaplingResponderTimeout 5
        SSLStaplingReturnResponderErrors off
    </If>

    # Logging
    ErrorLog ${VHOST_LOG_DIR}/${VHOST_NAME}_ssl_error.log
    CustomLog ${VHOST_LOG_DIR}/${VHOST_NAME}_ssl_access.log wafguard

    # ModSecurity rules for this VHost
    Include /etc/modsecurity.d/vhosts/${VHOST_NAME}-setup.conf

    # Document Root
    DocumentRoot "${VHOST_DOCUMENT_ROOT}"

    <Directory "${VHOST_DOCUMENT_ROOT}">
        Options -Indexes -FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    # Health Check endpoint
    <Location "${VHOST_HEALTH_CHECK_PATH}">
        ProxyPass "!"
        Require all granted
    </Location>

    # Reverse Proxy
    ProxyPass / ${VHOST_BACKEND_URL}/
    ProxyPassReverse / ${VHOST_BACKEND_URL}/

    # WebSocket support
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "wss://${VHOST_BACKEND_URL}/$1" [P,L]

    # Security Headers
    <IfModule headers_module>
        Header always set X-Content-Type-Options "nosniff"
        Header always set X-Frame-Options "${VHOST_X_FRAME_OPTIONS}"
        Header always set Referrer-Policy "${VHOST_REFERRER_POLICY}"
        Header always set Permissions-Policy "${VHOST_PERMISSIONS_POLICY}"
        Header always set Content-Security-Policy "${VHOST_CSP}"

        # HSTS
        <If "${VHOST_HSTS_ENABLED} == 'true'">
            Header always set Strict-Transport-Security "max-age=${VHOST_HSTS_MAX_AGE}; includeSubDomains; preload"
        </If>
    </IfModule>
</VirtualHost>
</If>

# ============================================================================
# End of VHost: ${VHOST_NAME}
# ============================================================================